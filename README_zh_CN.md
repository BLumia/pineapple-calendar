# Pineapple Calendar

写这玩意儿的目的主要是为了解决我们，好吧，我，没法在 KDE 下直接看农历的问题。于是目前的主要目标就是能提供一套比较通用的代码（比如以库的形式）以便于能写一个 Plasmoid 给 Plasma 5 桌面环境来显示中国农历，并且还能同时用于开发一个简单的独立的应用程序来做测试和便于后续做一些额外的功能。

尽管这个项目目前只打算提供简体中文农历支持，但我还是希望我的这套玩意儿可以比较灵活/可扩展，以便于实现其它日历系统的支持。

不过我其实压根不怎么懂什么日期时间之类的玩意儿，尤其是还要处理不同的地域习俗啊日期啊之类的问题，所以如果这里提到的东西如果有错，烦请您务必指正。我也会尽可能提供有必要的链接。

## 预期产出

### 当前目标

 - 一个用于 KDE Plasma 5 的 Plasmoid （桌面插件），能...
   - 将 *Gregorian 日历（格列高利历、公历）* 作为主日历.
   - 能够显示简体中文农历作为备用日历.
 - 一个独立的 Qt 应用程序，能...
   - 将 *Gregorian 日历* 作为主日历，能选择并设置通过应用提供的插件系统载入的日历作为备用日历.
   - 自带一个简体中文农历插件.
   - 尽可能多的和 Plasmoid 插件共用代码.

### 非目标，但或许会考虑支持

 - 支持日历事件.
   - 支持通过日历事件来支持节气显示.
   - 支持 ics 格式.

## 问题

### 为毛线不用 QCalendar?

目前 QCalendar 压根不支持农历...

我写这个 README 时 Qt 5.15.1 所支持的日历系统有这些:

"Julian", "Islamic Civil", "Jalali", "Milankovic", "Persian", "Islamic", "islamic-civil", "islamicc", "gregory", "Gregorian"

### 为毛线不写 QCalendar 插件?

*注：我不确定下面的这些到底对不对，如果不对或者我漏掉了什么内容的话，请务必告诉我，谢谢！*

因为在查找日历系统和 QCalendar 支持的资料时，发现了一些问题，下面列一些我觉得非常奇怪的来自 QCalendar 实现的问题。

首先，要提供自己的 QCalendar 插件就需要继承 `QCalendarBackend`，然而这玩意儿是个私有 API，另外在公开的 API 中，甚至还有个 `QCalendar::YearMonthDay` 类型压根没文档。

其次，目前的 QCalendar 接口设计似乎压根没法干净的处理闰月的情况。比如，假设今年闰八月，那按照 QCalendar 的实现，我不知道这里如果取月数应当得到多少。假设如果得到 9，那这到底是表示九月还是闰八月？

*评注: 有个 `QCalendar::monthName()` 接口可以部分的解决这个问题，我们能通过这个接口拿到想要的显示名称，但还是没法知道某个月到底是不是闰月*

~~最后，QCalendar 似乎压根不关心时区问题，当调用 `QCalendar::partsFromDate()` 的时候，我不知道应该按哪个时区处理传进来的 `QDate`...~~

*评注：QDate 应该总是一个 proleptic Gregorian calendar 所对应的日期..?*

### 为毛线要提供接口和实现？为毛不直接只写一个实现？

如上面所提，尽管我只打算提供一个简体中文农历的支持，但我还是希望这份代码可以灵活到可以方便的实现其它日历系统的支持。独立版的应用将用 Gregorian 日历作为主日历并能通过设置来选择所需使用的替代日历。替代日历会是从插件系统获取的，所以说不定有人可以从这份架子代码受益，直接复用已有代码并进行适当修改来使其能符合自己的使用需求。

另外，在查资料的时候，还发现 [ICU 可能会拿到错误的农历日期](https://www.v2ex.com/t/505601)，尽管我仍然打算用 icu4c 来做农历支持，但如果有提供一套方便的插件机制的话，如果有人希望，也可以自己实现插件来换掉目前来自 ICU 的农历支持。

### 为毛线不向已有项目贡献代码？

其实并不是不向而是我太菜了。尽管主要目标听上去非常简单，但要想清真的实现这套东西还是要考虑很多地方的。关于日历系统的很多东西我目前都不算很熟悉，所以我觉得我能搞清楚这些东西之后，再考虑向已有项目贡献也不迟。

另外我们也得确定已有项目会不会接受类似的特性请求。我如果觉得时机合适了，我会先发个特性请求来看看已有项目有没有意向进行这种支持再说。

### ~~为毛线不 fork 现有项目？~~

~~对于 Plasmoid 插件，我原本是打算 fork KDE plasma 官方的日历插件来着，但发现想把官方的日历插件从 `plasma-workspace` 中拆出来似乎并不简单。并且，它提供的日历接口目前看上去还不错（至少没想象的那么糟糕），于是我就可以直接写个简单的 plasmoid 插件来扩展 plasma calendar QML 控件来使它符合我的需求。~~

*edit: files under `/plasmoid/package/contents/ui/calendar/` forked from `plasma-workspace` with path `/src/declarativeimports/calendar/qml/` and commit hash `431d4cc0d4507ff8dc6b64fc039817635b600e65`*

至于独立的应用，由于（至少目前）独立应用的存在目的是用来实验接口和测试，所以显然自己手写是更合适的选择。

### 许可协议？

还没定，但一定会是自由软件。
